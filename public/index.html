<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friends Chat ðŸ’¬</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
  <style>
    :root {
      --bg-color: #0b0d11;
      --header-bg: rgba(255, 255, 255, 0.05);
      --bubble-me: #0084ff;
      --bubble-them: #2f3136;
      --text-main: #ffffff;
      --accent: #5865f2;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }

    .header {
      background: var(--header-bg); padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }

    /* System/Notification Messages */
    .sys-msg { text-align: center; font-size: 0.75rem; color: #888; margin: 5px 0; }

    #typing-monitor { padding: 0 25px 5px 25px; font-size: 0.8rem; font-style: italic; color: #888; height: 20px; }

    .msg-row { display: flex; width: 100%; align-items: flex-end; }
    .msg-row.me { justify-content: flex-end; }
    .msg-row.them { justify-content: flex-start; }

    .bubble {
      padding: 10px 15px; border-radius: 20px; max-width: 70%; position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pop 0.25s ease;
    }

    /* Reply Style */
    .reply-quote {
      background: rgba(0,0,0,0.2); border-left: 3px solid var(--accent);
      padding: 5px 8px; font-size: 0.75rem; border-radius: 5px; margin-bottom: 5px; opacity: 0.8;
    }

    .me .bubble { background: var(--bubble-me); border-bottom-right-radius: 4px; }
    .them .bubble { background: var(--bubble-them); border-bottom-left-radius: 4px; }

    .user-label { font-size: 0.7rem; font-weight: bold; margin-bottom: 3px; display: block; opacity: 0.7; }

    .options-btn {
      cursor: pointer; font-size: 1rem; padding: 5px; color: #666; opacity: 0; transition: 0.2s;
    }
    .msg-row:hover .options-btn { opacity: 1; }

    /* Reply Preview Bar */
    #reply-preview {
      display: none; background: #1e1f23; padding: 10px 20px;
      border-top: 2px solid var(--accent); justify-content: space-between; align-items: center;
    }

    .input-area { background: #1e1f23; padding: 15px 20px; display: flex; gap: 10px; align-items: center; }

    input { background: #2f3136; border: none; color: white; padding: 12px 18px; border-radius: 25px; outline: none; }
    #message { flex: 1; }
    #username { width: 80px; text-align: center; border: 1px solid #444; }

    .send-btn { background: var(--bubble-me); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }

    @keyframes pop { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

<div class="header">
  <span><strong>Friends Chat</strong> ðŸ’¬</span>
  <select id="theme" onchange="applyTheme()">
    <option value="dark">Dark Mode</option>
    <option value="ocean">Ocean Blue</option>
    <option value="sunset">Sunset Mixed</option>
  </select>
</div>

<div id="messages"></div>
<div id="typing-monitor"></div>

<div id="reply-preview">
  <div id="reply-text" style="font-size: 0.8rem; color: #bbb;"></div>
  <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;">âœ•</button>
</div>

<div class="input-area">
  <button id="emoji-trigger" style="background:none; border:none; font-size:1.6rem; cursor:pointer;">ðŸ˜Š</button>
  <input id="username" placeholder="Name">
  <input id="message" placeholder="Type a message...">
  <button class="send-btn" onclick="sendMessage()">âž”</button>
</div>

<script>
  const socket = io();
  const messageInput = document.getElementById('message');
  const usernameInput = document.getElementById('username');
  let currentReply = null;

  // 1. Emoji Picker
  window.onload = () => {
    const trigger = document.querySelector('#emoji-trigger');
    const picker = new EmojiButton({ theme: 'dark', position: 'top-start' });
    picker.on('emoji', selection => { messageInput.value += selection.emoji; messageInput.focus(); });
    trigger.addEventListener('click', () => picker.togglePicker(trigger));
  };

  // 2. Typing Logic
  let isTyping = false;
  let typingTimer;
  messageInput.addEventListener('input', () => {
    if (!isTyping) { isTyping = true; socket.emit('typing', usernameInput.value || "Someone"); }
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => { isTyping = false; socket.emit('stop typing'); }, 2000);
  });

  // 3. Send Logic
  function sendMessage() {
    const u = usernameInput.value;
    const m = messageInput.value;
    if (u && m) {
      socket.emit("chat message", { user: u, text: m, replyTo: currentReply });
      messageInput.value = "";
      cancelReply();
    }
  }

  // 4. Reply Management
  function setReply(id, user, text) {
    currentReply = { user, text };
    document.getElementById('reply-preview').style.display = 'flex';
    document.getElementById('reply-text').innerText = `Replying to ${user}: "${text.substring(0, 30)}..."`;
    messageInput.focus();
  }

  function cancelReply() {
    currentReply = null;
    document.getElementById('reply-preview').style.display = 'none';
  }

  // 5. Options Menu
  function openOptions(id, user, text) {
    const isMe = user === usernameInput.value;
    const action = prompt("Type 'e' to Edit, 'd' to Delete, 'r' to Reply:");
    if(action === 'e' && isMe) {
      const newText = prompt("Edit message:", text);
      if(newText) socket.emit("edit message", { id, newText });
    } else if(action === 'd' && isMe) {
      if(confirm("Delete message?")) socket.emit("delete message", id);
    } else if(action === 'r') {
      setReply(id, user, text);
    }
  }

  // 6. Socket Handlers
  socket.on("chat message", (data) => {
    const container = document.getElementById("messages");
    const isMe = data.user === usernameInput.value;
    const row = document.createElement("div");
    row.className = `msg-row ${isMe ? 'me' : 'them'}`;
    row.id = `msg-${data.id}`;

    let replyHtml = data.replyTo ? `<div class="reply-quote"><strong>${data.replyTo.user}</strong>: ${data.replyTo.text}</div>` : '';

    row.innerHTML = `
      ${isMe ? `<span class="options-btn" onclick="openOptions('${data.id}', '${data.user}', '${data.text}')">â‹®</span>` : ''}
      <div class="bubble">
        <span class="user-label">${isMe ? 'You' : data.user}</span>
        ${replyHtml}
        <div class="msg-text">${data.text}</div>
      </div>
      ${!isMe ? `<span class="options-btn" onclick="openOptions('${data.id}', '${data.user}', '${data.text}')">â‹®</span>` : ''}
    `;
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  });

  socket.on("user status", (msg) => {
    const row = document.createElement("div"); row.className = "sys-msg";
    row.innerText = msg; document.getElementById("messages").appendChild(row);
  });

  socket.on("display typing", (name) => { document.getElementById('typing-monitor').innerText = `${name} is typing...`; });
  socket.on("hide typing", () => { document.getElementById('typing-monitor').innerText = ""; });
  socket.on("message edited", (data) => { 
    const el = document.querySelector(`#msg-${data.id} .msg-text`);
    if(el) el.innerHTML = data.text + " <small style='opacity:0.5'>(edited)</small>"; 
  });
  socket.on("message deleted", (id) => { const el = document.getElementById(`msg-${id}`); if(el) el.remove(); });

  function applyTheme() {
    const theme = document.getElementById('theme').value;
    const root = document.querySelector(':root');
    if (theme === 'ocean') { root.style.setProperty('--bg-color', '#001529'); root.style.setProperty('--bubble-me', '#1890ff'); }
    else if (theme === 'sunset') { root.style.setProperty('--bg-color', '#2d1b33'); root.style.setProperty('--bubble-me', 'linear-gradient(45deg, #ff7e5f, #feb47b)'); }
    else { root.style.setProperty('--bg-color', '#0b0d11'); root.style.setProperty('--bubble-me', '#0084ff'); }
  }

  messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friends Chat ðŸ’¬</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-dark: #0e1525;
      --modal-bg: rgba(28, 35, 51, 0.95);
      --accent: #f97316;
      --btn-bg: #2d3548;
      --text-main: #f5f9fc;
      --me-bubble: #0084ff;
      --them-bubble: #232a3b;
    }

    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-dark); color: var(--text-main); overflow: hidden;
    }

    /* --- BACKGROUND ANIMATIONS --- */
    .bg-animation {
      position: fixed; inset: 0; z-index: -1;
      background: linear-gradient(45deg, #0e1525, #1c2333, #0e1525);
      background-size: 400% 400%; animation: gradientBG 15s ease infinite;
    }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .floating-blob {
      position: absolute; width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(249, 115, 22, 0.15) 0%, rgba(0,0,0,0) 70%);
      border-radius: 50%; filter: blur(40px); animation: move 20s infinite alternate; z-index: -1;
    }
    @keyframes move { from { transform: translate(-10%, -10%); } to { transform: translate(100%, 80%); } }

    /* --- LOGIN --- */
    #login-overlay {
      position: fixed; inset: 0; z-index: 10000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(8px); transition: opacity 0.4s ease;
    }
    .login-modal {
      background: var(--modal-bg); width: 100%; max-width: 400px;
      padding: 40px; border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center;
      animation: modalEntry 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalEntry { from { opacity: 0; transform: translateY(30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .auth-btn {
      width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1); background: var(--btn-bg);
      color: white; font-weight: 600; cursor: pointer; display: flex;
      align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease;
    }
    .guest-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
    #guest-name-area { display: none; margin-top: 20px; }
    #username-input {
      width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #3e4451;
      background: #0e1525; color: white; margin-bottom: 15px; outline: none; box-sizing: border-box;
    }
    .join-chat-btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }

    /* --- CHAT --- */
    #chat-container { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease; }
    .header { padding: 15px 25px; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
    #online-count { font-size: 13px; color: #4ade80; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    #online-count::before { content: ''; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }

    #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
    .msg-row { display: flex; width: 100%; position: relative; animation: msgSlideUp 0.3s forwards; }
    @keyframes msgSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .bubble { padding: 12px 18px; border-radius: 18px; max-width: 70%; background: var(--them-bubble); position: relative; }
    .me .bubble { background: var(--me-bubble); border-bottom-right-radius: 4px; color: white; }
    .them .bubble { border-bottom-left-radius: 4px; }
    .user-label { font-size: 11px; font-weight: 700; margin-bottom: 4px; display: block; }
    .msg-row.me { justify-content: flex-end; }

    /* Media Styling */
    .chat-media { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }

    .reply-content { background: rgba(0,0,0,0.2); border-left: 3px solid var(--accent); padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 8px; opacity: 0.8; }
    .msg-actions { display: flex; gap: 8px; font-size: 11px; opacity: 0; transition: 0.2s; position: absolute; bottom: -18px; }
    .msg-row:hover .msg-actions { opacity: 1; }
    .me .msg-actions { right: 0; }
    .msg-actions span { cursor: pointer; color: #9ca3af; }
    .msg-actions span:hover { color: white; }

    #typing-indicator { padding: 0 25px 5px; font-size: 11px; color: #4ade80; font-style: italic; min-height: 15px; }

    .input-container { background: rgba(28, 35, 51, 0.8); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.08); }
    #reply-preview { display: none; padding: 10px 25px; background: rgba(249, 115, 22, 0.1); border-left: 4px solid var(--accent); justify-content: space-between; align-items: center; }

    .input-area { padding: 15px 25px; display: flex; gap: 10px; align-items: center; }
    #minput { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 20px; border-radius: 25px; outline: none; }
    
    .icon-btn { background: var(--btn-bg); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; }
    .icon-btn:hover { background: #3e4451; }
    .send-btn { background: var(--me-bubble); color: white; border: none; padding: 0 25px; height: 45px; border-radius: 25px; cursor: pointer; font-weight: 600; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div class="bg-animation"></div>
  <div class="floating-blob" style="top: 10%; left: 10%;"></div>
  <div class="floating-blob" style="bottom: 10%; right: 10%; background: radial-gradient(circle, rgba(0, 132, 255, 0.1) 0%, transparent 70%);"></div>

  <div id="login-overlay">
    <div class="login-modal">
      <div style="font-size: 40px; margin-bottom: 10px;">âš¡</div>
      <h2>Log in to Friends Chat</h2>
      <button class="auth-btn" onclick="showInput()">Continue as Guest</button>
      <div id="guest-name-area">
        <input type="text" id="username-input" placeholder="Enter display name..." autocomplete="off">
        <button class="join-chat-btn" onclick="startChat()">Start Chatting</button>
      </div>
    </div>
  </div>

  <div id="chat-container">
    <div class="header">
      <strong>Friends Chat ðŸ’¬</strong>
      <div id="online-count">Online</div>
    </div>
    <div id="messages"></div>
    <div id="typing-indicator"></div>
    <div class="input-container">
      <div id="reply-preview">
        <div id="reply-text" style="font-size: 12px;">Replying...</div>
        <span onclick="cancelReply()" style="cursor:pointer;">âœ•</span>
      </div>
      <div class="input-area">
        <input type="file" id="file-input" accept="image/*,video/*" style="display:none" onchange="handleFile(this)">
        <button class="icon-btn" onclick="document.getElementById('file-input').click()">ðŸ“Ž</button>
        <input id="minput" placeholder="Write something..." autocomplete="off">
        <button class="send-btn" id="send-btn" onclick="send()">Send</button>
      </div>
    </div>
  </div>

<script>
  const socket = io();
  let myName = "", replyingTo = null, editingId = null, typingTimeout;
  
  const stringToColor = (str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360}, 70%, 70%)`;
  };

  function showInput() { document.getElementById('guest-name-area').style.display = 'block'; document.getElementById('username-input').focus(); }
  function startChat() {
    const n = document.getElementById('username-input').value.trim();
    if(n) { myName = n; document.getElementById('login-overlay').style.display = 'none'; document.getElementById('chat-container').style.display = 'flex'; socket.emit('user joined', myName); }
  }

  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const type = file.type.startsWith('video') ? 'video' : 'image';
      socket.emit('chat message', { user: myName, text: "", file: e.target.result, fileType: type, replyTo: replyingTo });
      cancelReply();
    };
    reader.readAsDataURL(file);
    input.value = ""; // Reset
  }

  function send() {
    const input = document.getElementById('minput');
    const text = input.value.trim();
    if(!text) return;
    if(editingId) {
      socket.emit('edit message', { id: editingId, text: text });
      editingId = null; document.getElementById('send-btn').innerText = "Send";
    } else {
      socket.emit('chat message', { user: myName, text: text, replyTo: replyingTo });
    }
    input.value = ""; cancelReply(); socket.emit('stop typing');
  }

  document.getElementById('minput').addEventListener('input', () => {
    socket.emit('typing', myName); clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => socket.emit('stop typing'), 2000);
  });

  function setReply(id, user, text) {
    replyingTo = { id, user, text: text || "Media" };
    document.getElementById('reply-preview').style.display = 'flex';
    document.getElementById('reply-text').innerText = `Replying to ${user}`;
    document.getElementById('minput').focus();
  }
  function cancelReply() { replyingTo = null; document.getElementById('reply-preview').style.display = 'none'; }
  function startEdit(id, text) { editingId = id; document.getElementById('minput').value = text; document.getElementById('send-btn').innerText = "Save"; document.getElementById('minput').focus(); }
  function deleteMsg(id) { if(confirm("Delete?")) socket.emit('delete message', id); }

  socket.on('user typing', (user) => { document.getElementById('typing-indicator').innerText = `${user} is typing...`; });
  socket.on('user stop typing', () => { document.getElementById('typing-indicator').innerText = ''; });
  socket.on('update online count', (count) => { document.getElementById('online-count').innerText = `${count} Online`; });

  socket.on('chat message', (d) => {
    const isMe = d.user === myName;
    const m = document.createElement('div');
    m.className = `msg-row ${isMe ? 'me' : 'them'}`; m.id = `msg-${d.id}`;
    
    let replyHtml = d.replyTo ? `<div class="reply-content"><b>${d.replyTo.user}:</b> ${d.replyTo.text}</div>` : "";
    let contentHtml = d.text ? `<span class="text-content">${d.text}</span>` : "";
    
    if(d.file) {
      contentHtml += d.fileType === 'video' 
        ? `<video src="${d.file}" class="chat-media" controls></video>` 
        : `<img src="${d.file}" class="chat-media">`;
    }

    m.innerHTML = `
      <div class="bubble">
        <span class="user-label" style="color: ${isMe ? '#fff' : stringToColor(d.user)}">${isMe ? 'You' : d.user}</span>
        ${replyHtml} ${contentHtml}
        <div class="msg-actions">
          <span onclick="setReply('${d.id}', '${d.user}', '${d.text}')">Reply</span>
          ${isMe && d.text ? `<span onclick="startEdit('${d.id}', '${d.text}')">Edit</span>` : ''}
          ${isMe ? `<span onclick="deleteMsg('${d.id}')">Delete</span>` : ''}
        </div>
      </div>`;
    
    document.getElementById('messages').appendChild(m);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  });

  socket.on('message deleted', (id) => { const el = document.getElementById(`msg-${id}`); if(el) el.remove(); });
  socket.on('message edited', (d) => { const el = document.querySelector(`#msg-${d.id} .text-content`); if(el) el.innerText = d.text + " (edited)"; });
  socket.on('user status', (msg) => {
    const s = document.createElement('div'); s.style = "text-align:center; font-size:11px; color:rgba(255,255,255,0.3); margin:10px 0;";
    s.innerText = msg; document.getElementById('messages').appendChild(s);
  });

  document.getElementById('minput').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
</script>
</body>
</html>
